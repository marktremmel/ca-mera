(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function n(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(s){if(s.ep)return;s.ep=!0;const a=n(s);fetch(s.href,a)}})();class Re{constructor(e){this.video=e,this.stream=null,this.facingMode="environment"}async start(){try{this.stop();const e={video:{facingMode:this.facingMode,width:{ideal:1280},height:{ideal:960}},audio:!1};return this.stream=await navigator.mediaDevices.getUserMedia(e),this.video.srcObject=this.stream,await this.video.play(),!0}catch(e){return console.error("Camera access denied or unavailable:",e),!1}}stop(){this.stream&&(this.stream.getTracks().forEach(e=>e.stop()),this.stream=null)}async flip(){return this.facingMode=this.facingMode==="environment"?"user":"environment",this.start()}captureFrame(e=128/112){const n=this.video.videoWidth,o=this.video.videoHeight;if(!n||!o)return null;let s,a,c,i;n/o>e?(a=o,s=Math.round(o*e),c=Math.round((n-s)/2),i=0):(s=n,a=Math.round(n/e),c=0,i=Math.round((o-a)/2));const d=new OffscreenCanvas(s,a).getContext("2d");return d.drawImage(this.video,c,i,s,a,0,0,s,a),d.getImageData(0,0,s,a)}}const O={classic:{name:"Classic GB",colors:["#0f380f","#306230","#8bac0f","#9bbc0f"]},sunset:{name:"Sunset",colors:["#1a1034","#8b3a62","#e05a46","#f2d09e"]},amber:{name:"Amber",colors:["#1b1000","#6b4e00","#c8a800","#ffffff"]},teal:{name:"Teal",colors:["#0d1b0e","#1a5c2a","#3cb460","#9fffb0"]},noir:{name:"Noir",colors:["#000000","#555555","#aaaaaa","#ffffff"]},vaporwave:{name:"Vapor",colors:["#2b0040","#8000a0","#ff6090","#ffcc80"]}},Q="ca_mera_custom_palettes";function L(){try{return JSON.parse(localStorage.getItem(Q)||"{}")}catch{return{}}}function Se(t,e){const n=L();n[t]=e,localStorage.setItem(Q,JSON.stringify(n))}function Be(t){const e=L();delete e[t],localStorage.setItem(Q,JSON.stringify(e))}function ke(t){const e=parseInt(t.slice(1),16),n=e>>16&255,o=e>>8&255,s=e&255;return[n,o,s]}function De(t){let e=O[t];return e||(e=L()[t]),e||(e=O.classic),e.colors.map(ke)}const V=128,Oe=112,R={"8:7":{w:128,h:112,label:"8:7"},"1:1":{w:128,h:128,label:"1:1"},"9:16":{w:128,h:228,label:"9:16"}},x=Object.keys(R),Pe=[[0/16,8/16,2/16,10/16],[12/16,4/16,14/16,6/16],[3/16,11/16,1/16,9/16],[15/16,7/16,13/16,5/16]],Te=[0,-1,0,-1,5,-1,0,-1,0];function Z(t,e,n={}){const{contrast:o=1.2,edgeStrength:s=.3,mirror:a=!1,outWidth:c=V,outHeight:i=Oe}=n,r=De(e);let d=t;a&&(d=Me(d));const g=_e(d,c,i),l=Ae(g);return Fe(l,o),s>0&&Ue(l,s),Ne(l,r),l}function Me(t){const{width:e,height:n,data:o}=t,s=new ImageData(e,n),a=s.data;for(let c=0;c<n;c++)for(let i=0;i<e;i++){const r=(c*e+i)*4,d=(c*e+(e-1-i))*4;a[d]=o[r],a[d+1]=o[r+1],a[d+2]=o[r+2],a[d+3]=o[r+3]}return s}function _e(t,e,n){const s=new OffscreenCanvas(e,n).getContext("2d"),a=new OffscreenCanvas(t.width,t.height);return a.getContext("2d").putImageData(t,0,0),s.drawImage(a,0,0,e,n),s.getImageData(0,0,e,n)}function Ae(t){const e=t.data;for(let n=0;n<e.length;n+=4){const o=.299*e[n]+.587*e[n+1]+.114*e[n+2];e[n]=e[n+1]=e[n+2]=o}return t}function Fe(t,e){const n=t.data;for(let o=0;o<n.length;o+=4){const s=Math.max(0,Math.min(255,((n[o]/255-.5)*e+.5)*255));n[o]=n[o+1]=n[o+2]=s}}function Ue(t,e){const{width:n,height:o,data:s}=t,a=new Uint8ClampedArray(s);for(let c=1;c<o-1;c++)for(let i=1;i<n-1;i++){let r=0;for(let m=-1;m<=1;m++)for(let p=-1;p<=1;p++){const N=((c+m)*n+(i+p))*4;r+=a[N]*Te[(m+1)*3+(p+1)]}const d=(c*n+i)*4,g=a[d]*(1-e)+r*e,l=Math.max(0,Math.min(255,g));s[d]=s[d+1]=s[d+2]=l}}function Ne(t,e){const{width:n,height:o,data:s}=t;for(let a=0;a<o;a++)for(let c=0;c<n;c++){const i=(a*n+c)*4,r=s[i]/255,d=Pe[a%4][c%4]-.5,l=r+d*.33;let m;l<.25?m=0:l<.5?m=1:l<.75?m=2:m=3;const[p,N,Ce]=e[m];s[i]=p,s[i+1]=N,s[i+2]=Ce,s[i+3]=255}}function ge(t,e){const n=t.width,o=t.height,s=n*e,a=o*e,i=new OffscreenCanvas(s,a).getContext("2d");i.imageSmoothingEnabled=!1;const r=new OffscreenCanvas(n,o);return r.getContext("2d").putImageData(t,0,0),i.drawImage(r,0,0,s,a),i.getImageData(0,0,s,a)}const ee="ca_mera_photos";function M(){try{const t=localStorage.getItem(ee);return t?JSON.parse(t):[]}catch{return[]}}function pe(t,e){const n=M();let o;if(t instanceof OffscreenCanvas){const a=document.createElement("canvas");a.width=t.width,a.height=t.height,a.getContext("2d").drawImage(t,0,0),o=a.toDataURL("image/png")}else o=t.toDataURL("image/png");const s={id:`photo_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,dataUrl:o,palette:e,timestamp:Date.now()};return n.unshift(s),n.length>30&&n.pop(),localStorage.setItem(ee,JSON.stringify(n)),s.id}function xe(t){const e=M().filter(n=>n.id!==t);localStorage.setItem(ee,JSON.stringify(e))}function ae(t,e="ca_mera_photo.png"){const n=document.createElement("a");n.href=t,n.download=e,n.click()}async function He(t){try{const e=await(await fetch(t)).blob(),n=new File([e],"ca_mera_photo.png",{type:"image/png"});if(navigator.canShare&&navigator.canShare({files:[n]}))return await navigator.share({files:[n],title:"ca_mera",text:"Shot on ca_mera ðŸ“¸"}),!0}catch(e){e.name!=="AbortError"&&console.error("Share failed:",e)}return!1}const _={none:{id:"none",name:"None",draw:null},classic:{id:"classic",name:"Classic",draw:Ge},bold:{id:"bold",name:"Bold",draw:$e},film:{id:"film",name:"Film Strip",draw:je},polaroid:{id:"polaroid",name:"Instant",draw:We},pixel:{id:"pixel",name:"Decor",draw:qe}};function Ge(t,e,n,o){t.strokeStyle=o[0],t.lineWidth=8,t.lineJoin="round",t.strokeRect(8/2,8/2,e-8,n-8),t.strokeStyle=o[3],t.lineWidth=1,t.strokeRect(8,8,e-16,n-16)}function $e(t,e,n,o){t.fillStyle=o[0],t.fillRect(0,0,e,12),t.fillRect(0,n-12,e,12),t.fillRect(0,0,12,n),t.fillRect(e-12,0,12,n),t.fillStyle=o[2],t.fillRect(2,2,8,8),t.fillRect(e-10,2,8,8),t.fillRect(2,n-10,8,8),t.fillRect(e-10,n-10,8,8)}function je(t,e,n,o){t.fillStyle=o[0],t.fillRect(0,0,16,n),t.fillRect(e-16,0,16,n),t.fillStyle=o[3];const a=8,c=10,i=16;for(let r=i;r<n;r+=i+c)t.fillRect(4,r,a,c),t.fillRect(e-16+4,r,a,c)}function We(t,e,n,o){t.fillStyle=o[3],t.fillRect(0,0,e,6),t.fillRect(0,0,6,n),t.fillRect(e-6,0,6,n),t.fillRect(0,n-30,e,30),t.strokeStyle=o[1],t.lineWidth=1,t.strokeRect(6,6,e-12,n-6-30)}function qe(t,e,n,o){t.fillStyle=o[1],t.fillRect(0,0,16,4),t.fillRect(0,0,4,16),t.fillRect(e-16,0,16,4),t.fillRect(e-4,0,4,16),t.fillRect(0,n-16,4,16),t.fillRect(0,n-4,16,4),t.fillRect(e-4,n-16,4,16),t.fillRect(e-16,n-4,16,4),t.fillStyle=o[2],t.fillRect(6,6,2,2),t.fillRect(e-8,6,2,2),t.fillRect(6,n-8,2,2),t.fillRect(e-8,n-8,2,2)}class Je{constructor(e){this.canvas=e,this.recorder=null,this.chunks=[],this.stream=null,this.isRecording=!1}startRecording(){if(this.isRecording)return;this.stream=this.canvas.captureStream(15);let n=["video/webm;codecs=vp9","video/webm;codecs=vp8","video/webm","video/mp4"].find(o=>MediaRecorder.isTypeSupported(o))||"video/webm";try{this.recorder=new MediaRecorder(this.stream,{mimeType:n,videoBitsPerSecond:25e5})}catch(o){console.error("MediaRecorder error:",o),this.recorder=new MediaRecorder(this.stream)}this.chunks=[],this.recorder.ondataavailable=o=>{o.data.size>0&&this.chunks.push(o.data)},this.recorder.start(),this.isRecording=!0,console.log("Recording started",this.recorder.mimeType)}stopRecording(){return new Promise((e,n)=>{if(!this.isRecording||!this.recorder){e(null);return}this.recorder.onstop=()=>{const o=new Blob(this.chunks,{type:this.recorder.mimeType});this.isRecording=!1,this.stream.getTracks().forEach(s=>s.stop()),e(o)},this.recorder.stop()})}}let u="classic",b="none",A=1.2,F=.3,I="8:7",w=!1,v=0,Y=!1,f=null,ce=null,C=!1,k=null,E=null;const Ke=600,Ve=document.getElementById("camera-video"),y=document.getElementById("viewfinder"),h=y.getContext("2d"),H=document.getElementById("btn-shutter"),P=document.querySelector(".shutter-ring"),Ye=document.getElementById("btn-flip"),G=document.getElementById("btn-mirror"),ze=document.getElementById("btn-aspect"),Xe=document.getElementById("aspect-label"),Qe=document.getElementById("btn-timer"),$=document.getElementById("timer-badge"),Ze=document.getElementById("btn-frames"),et=document.getElementById("btn-settings"),tt=document.getElementById("btn-gallery"),nt=document.getElementById("btn-gallery-back"),ot=document.getElementById("btn-import"),j=document.getElementById("import-input"),st=document.getElementById("photo-count"),te=document.getElementById("gallery-panel"),W=document.getElementById("gallery-grid"),at=document.getElementById("gallery-count"),ve=document.getElementById("detail-panel"),q=document.getElementById("detail-canvas"),ct=document.getElementById("btn-detail-back"),it=document.getElementById("btn-download"),rt=document.getElementById("btn-share"),dt=document.getElementById("btn-delete"),lt=document.getElementById("contrast-slider"),mt=document.getElementById("edge-slider"),ut=document.getElementById("adjustments"),ie=document.getElementById("flash-overlay"),re=document.getElementById("countdown-overlay"),de=document.getElementById("countdown-number"),z=document.getElementById("palette-bar"),B=document.getElementById("palette-modal"),ne=document.getElementById("btn-add-palette"),ft=document.getElementById("btn-modal-close"),ht=document.getElementById("btn-save-palette"),gt=[document.getElementById("custom-c0"),document.getElementById("custom-c1"),document.getElementById("custom-c2"),document.getElementById("custom-c3")],J=document.getElementById("frames-modal"),pt=document.getElementById("btn-frames-close"),le=document.getElementById("frames-grid"),X=document.getElementById("review-modal"),K=document.getElementById("btn-review-close"),D=document.getElementById("review-video"),vt=document.getElementById("btn-save-video"),yt=document.getElementById("btn-discard-video"),U=new Re(Ve),ye=new Je(y);async function bt(){if(be(),h.imageSmoothingEnabled=!1,se(),St(),!await U.start()){Pt();return}Et(),S()}function be(){const{w:t,h:e,label:n}=R[I];(y.width!==t||y.height!==e)&&(y.width=t,y.height=e,h.imageSmoothingEnabled=!1),Xe.textContent=n}function oe(){let t=O[u];return t||(t=L()[u]),t?t.colors:["#000","#555","#aaa","#fff"]}function Et(){Y||(Y=!0,requestAnimationFrame(Ee))}function Ee(){if(!Y)return;const{w:t,h:e}=R[I],n=t/e,o=U.captureFrame(n);if(o){const s=Z(o,u,{contrast:A,edgeStrength:F,mirror:w,outWidth:t,outHeight:e});if(h.putImageData(s,0,0),b!=="none"){const a=_[b];a&&a.draw&&a.draw(h,t,e,oe())}C&&wt(h,t)}requestAnimationFrame(Ee)}function wt(t,e,n){Math.floor(Date.now()/500)%2===0&&(t.fillStyle="#e05a46",t.beginPath(),t.arc(e-10,10,4,0,Math.PI*2),t.fill())}function we(){const{w:t,h:e}=R[I],n=t/e,o=U.captureFrame(n);if(!o)return;const s=Z(o,u,{contrast:A,edgeStrength:F,mirror:w,outWidth:t,outHeight:e}),c=new OffscreenCanvas(t,e).getContext("2d");if(c.putImageData(s,0,0),b!=="none"){const g=_[b];g&&g.draw&&g.draw(c,t,e,oe())}const i=c.getImageData(0,0,t,e),r=ge(i,4),d=new OffscreenCanvas(r.width,r.height);d.getContext("2d").putImageData(r,0,0),pe(d,u),Ie(),S()}function Ie(){ie.classList.add("flash"),requestAnimationFrame(()=>{setTimeout(()=>{ie.classList.remove("flash")},250)})}function It(){C=!0,ye.startRecording(),P.style.background="#e05a46",P.style.transform="scale(1.2)"}async function Lt(){if(!C)return;C=!1,P.style.background="",P.style.transform="";const t=await ye.stopRecording();t&&t.size>0&&Ct(t)}function Ct(t){E=t,D.src=URL.createObjectURL(t),D.load(),D.play().catch(e=>console.log("Autoplay blocked",e)),X.classList.remove("hidden")}function me(t){t.preventDefault(),!(v>0)&&(k=setTimeout(()=>{It()},Ke))}function ue(t){if(t.preventDefault(),v>0){Rt(v);return}k&&(clearTimeout(k),k=null),C?Lt():we()}function Rt(t){let e=t;re.classList.remove("hidden"),de.textContent=e,document.body.style.pointerEvents="none",ce=setInterval(()=>{e--,e>0?de.textContent=e:(clearInterval(ce),re.classList.add("hidden"),document.body.style.pointerEvents="",we())},1e3)}function se(){Array.from(z.querySelectorAll(".palette-chip:not(#btn-add-palette)")).forEach(n=>n.remove()),Object.entries(O).forEach(([n,o])=>{fe(n,o.colors,o.name)});const e=L();Object.entries(e).forEach(([n,o])=>{fe(n,o.colors,o.name).addEventListener("contextmenu",a=>{a.preventDefault(),confirm(`Delete custom palette "${o.name}"?`)&&(Be(n),se(),u===n&&(u="classic"),T())})}),z.appendChild(ne),T()}function fe(t,e,n){const o=document.createElement("button");o.className="palette-chip",o.dataset.palette=t,o.title=n;const s=document.createElement("span");return s.className="chip-swatch",s.style.background=`linear-gradient(135deg, ${e[0]}, ${e[1]}, ${e[2]}, ${e[3]})`,o.appendChild(s),o.addEventListener("click",()=>{u=t,T()}),z.insertBefore(o,ne),o}function T(){document.querySelectorAll(".palette-chip").forEach(n=>n.classList.remove("active"));const e=document.querySelector(`.palette-chip[data-palette="${u}"]`);e&&e.classList.add("active")}function St(){le.innerHTML="",Object.values(_).forEach(t=>{const e=document.createElement("div");e.className=`frame-thumb ${b===t.id?"active":""}`,e.innerHTML=`<span class="frame-thumb-inner">${t.name}</span>`,e.addEventListener("click",()=>{b=t.id,document.querySelectorAll(".frame-thumb").forEach(n=>n.classList.remove("active")),e.classList.add("active")}),le.appendChild(e)})}function Bt(){const t=["mousedown","touchstart"],e=["mouseup","touchend","mouseleave","touchcancel"];t.forEach(n=>H.addEventListener(n,me)),e.forEach(n=>H.addEventListener(n,ue)),H.addEventListener("contextmenu",n=>n.preventDefault()),K.addEventListener("click",()=>{X.classList.add("hidden"),E&&(URL.revokeObjectURL(D.src),E=null)}),yt.addEventListener("click",()=>{K.click()}),vt.addEventListener("click",()=>{if(E){const n=new Date().toISOString().slice(0,19).replace(/:/g,"-"),o=E.type.includes("mp4")?"mp4":"webm",s=document.createElement("a");s.href=URL.createObjectURL(E),s.download=`ca_mera_anim_${n}.${o}`,s.click(),K.click()}}),Ye.addEventListener("click",()=>U.flip()),G.addEventListener("click",()=>{w=!w,G.style.opacity=w?"1":"0.5"}),G.style.opacity="0.5",ze.addEventListener("click",()=>{const o=(x.indexOf(I)+1)%x.length;I=x[o],be()}),Qe.addEventListener("click",()=>{v===0?v=3:v===3?v=10:v=0,v===0?$.classList.add("hidden"):($.textContent=v,$.classList.remove("hidden"))}),Ze.addEventListener("click",()=>{J.classList.remove("hidden")}),pt.addEventListener("click",()=>{J.classList.add("hidden")}),ot.addEventListener("click",()=>j.click()),j.addEventListener("change",n=>{const o=n.target.files[0];o&&Tt(o),j.value=""}),tt.addEventListener("click",kt),nt.addEventListener("click",Dt),ct.addEventListener("click",he),it.addEventListener("click",()=>{f&&ae(f.dataUrl,`ca_mera_${f.id}.png`)}),rt.addEventListener("click",async()=>{f&&(await He(f.dataUrl)||ae(f.dataUrl,`ca_mera_${f.id}.png`))}),dt.addEventListener("click",()=>{f&&(xe(f.id),he(),Le(),S())}),lt.addEventListener("input",n=>A=parseFloat(n.target.value)),mt.addEventListener("input",n=>F=parseFloat(n.target.value)),et.addEventListener("click",()=>{ut.classList.toggle("open")}),ne.addEventListener("click",()=>{B.classList.remove("hidden")}),ft.addEventListener("click",()=>{B.classList.add("hidden")}),ht.addEventListener("click",()=>{const n=gt.map(a=>a.value),o="custom_"+Date.now(),s="Custom "+(Object.keys(L()).length+1);Se(o,{name:s,colors:n}),se(),u=o,T(),B.classList.add("hidden")}),document.addEventListener("keydown",n=>{n.code==="Space"&&te.classList.contains("hidden")&&J.classList.contains("hidden")&&B.classList.contains("hidden")&&X.classList.contains("hidden")&&(n.preventDefault(),n.repeat||me(n))}),document.addEventListener("keyup",n=>{n.code==="Space"&&(n.preventDefault(),ue(n))})}function S(){const t=M().length;st.textContent=t,at.textContent=`${t} / 30`}function kt(){Le(),te.classList.remove("hidden")}function Dt(){te.classList.add("hidden")}function Le(){const t=M();if(W.innerHTML="",S(),t.length===0){W.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ“·</div>
        <div class="empty-state-text">NO PHOTOS YET<br/>TAP THE SHUTTER<br/>TO CAPTURE</div>
      </div>
    `;return}t.forEach(e=>{const n=document.createElement("div");n.className="gallery-thumb",n.innerHTML=`<img src="${e.dataUrl}" alt="Photo" loading="lazy" />`,n.addEventListener("click",()=>Ot(e)),W.appendChild(n)})}function Ot(t){f=t;const e=new Image;e.onload=()=>{q.width=e.width,q.height=e.height;const n=q.getContext("2d");n.imageSmoothingEnabled=!1,n.drawImage(e,0,0)},e.src=t.dataUrl,ve.classList.remove("hidden")}function he(){ve.classList.add("hidden"),f=null}function Pt(){h.fillStyle="#14141f",h.fillRect(0,0,V,V),h.fillStyle="#8888a0",h.font='8px "Press Start 2P"',h.textAlign="center",h.fillText("CAMERA ERROR",y.width/2,y.height/2)}Bt();bt();function Tt(t){const e=new Image;e.onload=()=>{const{w:n,h:o}=R[I],a=new OffscreenCanvas(e.width,e.height).getContext("2d");a.drawImage(e,0,0);const c=a.getImageData(0,0,e.width,e.height),i=Z(c,u,{contrast:A,edgeStrength:F,mirror:w,outWidth:n,outHeight:o}),d=new OffscreenCanvas(n,o).getContext("2d");if(d.putImageData(i,0,0),b!=="none"){const p=_[b];p&&p.draw&&p.draw(d,n,o,oe())}const g=d.getImageData(0,0,n,o),l=ge(g,4),m=new OffscreenCanvas(l.width,l.height);m.getContext("2d").putImageData(l,0,0),pe(m,u),Ie(),S(),URL.revokeObjectURL(e.src)},e.src=URL.createObjectURL(t)}
