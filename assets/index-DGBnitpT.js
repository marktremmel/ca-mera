(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const o of a)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function n(a){const o={};return a.integrity&&(o.integrity=a.integrity),a.referrerPolicy&&(o.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?o.credentials="include":a.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(a){if(a.ep)return;a.ep=!0;const o=n(a);fetch(a.href,o)}})();class q{constructor(t){this.video=t,this.stream=null,this.facingMode="environment"}async start(){try{this.stop();const t={video:{facingMode:this.facingMode,width:{ideal:640},height:{ideal:480}},audio:!1};return this.stream=await navigator.mediaDevices.getUserMedia(t),this.video.srcObject=this.stream,await this.video.play(),!0}catch(t){return console.error("Camera access denied or unavailable:",t),!1}}stop(){this.stream&&(this.stream.getTracks().forEach(t=>t.stop()),this.stream=null)}async flip(){return this.facingMode=this.facingMode==="environment"?"user":"environment",this.start()}captureFrame(){const t=this.video.videoWidth,n=this.video.videoHeight;if(!t||!n)return null;const s=128/112;let a,o,c,r;t/n>s?(o=n,a=Math.round(n*s),c=Math.round((t-a)/2),r=0):(a=t,o=Math.round(t/s),c=0,r=Math.round((n-o)/2));const f=new OffscreenCanvas(a,o).getContext("2d");return f.drawImage(this.video,c,r,a,o,0,0,a,o),f.getImageData(0,0,a,o)}}const Y={classic:{name:"Classic GB",colors:["#0f380f","#306230","#8bac0f","#9bbc0f"]},sunset:{name:"Sunset",colors:["#1a1034","#8b3a62","#e05a46","#f2d09e"]},amber:{name:"Amber",colors:["#1b1000","#6b4e00","#c8a800","#ffffff"]},teal:{name:"Teal",colors:["#0d1b0e","#1a5c2a","#3cb460","#9fffb0"]},noir:{name:"Noir",colors:["#000000","#555555","#aaaaaa","#ffffff"]},vaporwave:{name:"Vapor",colors:["#2b0040","#8000a0","#ff6090","#ffcc80"]}};function J(e){const t=parseInt(e.slice(1),16);return[t>>16&255,t>>8&255,t&255]}function z(e){const t=Y[e];if(!t)throw new Error(`Unknown palette: ${e}`);return t.colors.map(J)}const g=128,h=112,K=[[0/16,8/16,2/16,10/16],[12/16,4/16,14/16,6/16],[3/16,11/16,1/16,9/16],[15/16,7/16,13/16,5/16]],V=[0,-1,0,-1,5,-1,0,-1,0];function D(e,t,n={}){const{contrast:s=1.2,edgeStrength:a=.3}=n,o=z(t),c=W(e,g,h),r=X(c);return Q(r,s),a>0&&Z(r,a),tt(r,o),r}function W(e,t,n){const a=new OffscreenCanvas(t,n).getContext("2d"),o=new OffscreenCanvas(e.width,e.height);return o.getContext("2d").putImageData(e,0,0),a.drawImage(o,0,0,t,n),a.getImageData(0,0,t,n)}function X(e){const t=e.data;for(let n=0;n<t.length;n+=4){const s=.299*t[n]+.587*t[n+1]+.114*t[n+2];t[n]=t[n+1]=t[n+2]=s}return e}function Q(e,t){const n=e.data;for(let s=0;s<n.length;s+=4){const a=Math.max(0,Math.min(255,((n[s]/255-.5)*t+.5)*255));n[s]=n[s+1]=n[s+2]=a}}function Z(e,t){const{width:n,height:s,data:a}=e,o=new Uint8ClampedArray(a);for(let c=1;c<s-1;c++)for(let r=1;r<n-1;r++){let m=0;for(let d=-1;d<=1;d++)for(let u=-1;u<=1;u++){const C=((c+d)*n+(r+u))*4;m+=o[C]*V[(d+1)*3+(u+1)]}const f=(c*n+r)*4,A=o[f]*(1-t)+m*t,v=Math.max(0,Math.min(255,A));a[f]=a[f+1]=a[f+2]=v}}function tt(e,t){const{width:n,height:s,data:a}=e;for(let o=0;o<s;o++)for(let c=0;c<n;c++){const r=(o*n+c)*4,m=a[r]/255,f=K[o%4][c%4]-.5,v=m+f*.33;let d;v<.25?d=0:v<.5?d=1:v<.75?d=2:d=3;const[u,C,j]=t[d];a[r]=u,a[r+1]=C,a[r+2]=j,a[r+3]=255}}function U(e,t){const n=e.width,s=e.height,a=n*t,o=s*t,r=new OffscreenCanvas(a,o).getContext("2d");r.imageSmoothingEnabled=!1;const m=new OffscreenCanvas(n,s);return m.getContext("2d").putImageData(e,0,0),r.drawImage(m,0,0,a,o),r.getImageData(0,0,a,o)}const P="ca_mera_photos";function E(){try{const e=localStorage.getItem(P);return e?JSON.parse(e):[]}catch{return[]}}function F(e,t){const n=E();let s;if(e instanceof OffscreenCanvas){const o=document.createElement("canvas");o.width=e.width,o.height=e.height,o.getContext("2d").drawImage(e,0,0),s=o.toDataURL("image/png")}else s=e.toDataURL("image/png");const a={id:`photo_${Date.now()}_${Math.random().toString(36).slice(2,6)}`,dataUrl:s,palette:t,timestamp:Date.now()};return n.unshift(a),n.length>30&&n.pop(),localStorage.setItem(P,JSON.stringify(n)),a.id}function et(e){const t=E().filter(n=>n.id!==e);localStorage.setItem(P,JSON.stringify(t))}function M(e,t="ca_mera_photo.png"){const n=document.createElement("a");n.href=e,n.download=t,n.click()}async function nt(e){try{const t=await(await fetch(e)).blob(),n=new File([t],"ca_mera_photo.png",{type:"image/png"});if(navigator.canShare&&navigator.canShare({files:[n]}))return await navigator.share({files:[n],title:"ca_mera",text:"Shot on ca_mera ðŸ“¸"}),!0}catch(t){t.name!=="AbortError"&&console.error("Share failed:",t)}return!1}let p="classic",w=1.2,b=.3,B=!1,i=null;const at=document.getElementById("camera-video"),O=document.getElementById("viewfinder"),l=O.getContext("2d"),ot=document.getElementById("btn-shutter"),st=document.getElementById("btn-flip"),ct=document.getElementById("btn-settings"),rt=document.getElementById("btn-gallery"),it=document.getElementById("btn-gallery-back"),lt=document.getElementById("btn-import"),L=document.getElementById("import-input"),dt=document.getElementById("photo-count"),T=document.getElementById("gallery-panel"),x=document.getElementById("gallery-grid"),ft=document.getElementById("gallery-count"),G=document.getElementById("detail-panel"),S=document.getElementById("detail-canvas"),mt=document.getElementById("btn-detail-back"),ut=document.getElementById("btn-download"),gt=document.getElementById("btn-share"),ht=document.getElementById("btn-delete"),pt=document.getElementById("contrast-slider"),vt=document.getElementById("edge-slider"),yt=document.getElementById("adjustments"),k=document.getElementById("flash-overlay"),I=new q(at);async function Et(){if(O.width=g,O.height=h,l.imageSmoothingEnabled=!1,!await I.start()){Bt();return}wt(),y()}function wt(){B||(B=!0,requestAnimationFrame(N))}function N(){if(!B)return;const e=I.captureFrame();if(e){const t=D(e,p,{contrast:w,edgeStrength:b});l.putImageData(t,0,0)}requestAnimationFrame(N)}function _(){const e=I.captureFrame();if(!e)return;const t=D(e,p,{contrast:w,edgeStrength:b}),n=U(t,4),s=new OffscreenCanvas(n.width,n.height);s.getContext("2d").putImageData(n,0,0),F(s,p),H(),y()}function H(){k.classList.add("flash"),requestAnimationFrame(()=>{setTimeout(()=>{k.classList.remove("flash")},250)})}function bt(e){const t=new Image;t.onload=()=>{const s=new OffscreenCanvas(t.width,t.height).getContext("2d");s.drawImage(t,0,0);const a=s.getImageData(0,0,t.width,t.height),o=D(a,p,{contrast:w,edgeStrength:b});l.putImageData(o,0,0);const c=U(o,4),r=new OffscreenCanvas(c.width,c.height);r.getContext("2d").putImageData(c,0,0),F(r,p),H(),y(),URL.revokeObjectURL(t.src)},t.src=URL.createObjectURL(e)}function It(){const e=document.querySelectorAll(".palette-chip");e.forEach(t=>{t.addEventListener("click",()=>{e.forEach(n=>n.classList.remove("active")),t.classList.add("active"),p=t.dataset.palette})})}function Ct(){pt.addEventListener("input",e=>{w=parseFloat(e.target.value)}),vt.addEventListener("input",e=>{b=parseFloat(e.target.value)}),ct.addEventListener("click",()=>{yt.classList.toggle("open")})}function y(){const e=E().length;dt.textContent=e,ft.textContent=`${e} / 30`}function Lt(){$(),T.classList.remove("hidden")}function xt(){T.classList.add("hidden")}function $(){const e=E();if(x.innerHTML="",y(),e.length===0){x.innerHTML=`
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ“·</div>
        <div class="empty-state-text">NO PHOTOS YET<br/>TAP THE SHUTTER<br/>TO CAPTURE</div>
      </div>
    `;return}e.forEach(t=>{const n=document.createElement("div");n.className="gallery-thumb",n.innerHTML=`<img src="${t.dataUrl}" alt="Photo" loading="lazy" />`,n.addEventListener("click",()=>St(t)),x.appendChild(n)})}function St(e){i=e;const t=new Image;t.onload=()=>{S.width=t.width,S.height=t.height;const n=S.getContext("2d");n.imageSmoothingEnabled=!1,n.drawImage(t,0,0)},t.src=e.dataUrl,G.classList.remove("hidden")}function R(){G.classList.add("hidden"),i=null}function Bt(){l.fillStyle="#14141f",l.fillRect(0,0,g,h),l.fillStyle="#8888a0",l.font='8px "Press Start 2P"',l.textAlign="center",l.fillText("CAMERA",g/2,h/2-8),l.fillText("ACCESS",g/2,h/2+4),l.fillText("NEEDED",g/2,h/2+16)}function Ot(){ot.addEventListener("click",_),st.addEventListener("click",()=>I.flip()),lt.addEventListener("click",()=>L.click()),L.addEventListener("change",e=>{const t=e.target.files[0];t&&bt(t),L.value=""}),rt.addEventListener("click",Lt),it.addEventListener("click",xt),mt.addEventListener("click",R),ut.addEventListener("click",()=>{i&&M(i.dataUrl,`ca_mera_${i.id}.png`)}),gt.addEventListener("click",async()=>{i&&(await nt(i.dataUrl)||M(i.dataUrl,`ca_mera_${i.id}.png`))}),ht.addEventListener("click",()=>{i&&(et(i.id),R(),$(),y())}),It(),Ct(),document.addEventListener("keydown",e=>{e.code==="Space"&&T.classList.contains("hidden")&&(e.preventDefault(),_())})}Ot();Et();
